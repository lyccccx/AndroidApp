@{
    ViewBag.Title = "Test";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section HeadCss{
    <link href='~/Content/CSS/All-V2.css?data=@{string data = DateTime.Now.ToString();@data}' rel='stylesheet' />
    <link href='~/Content/CSS/MainPage.css' rel='stylesheet' />
    <link href='~/Content/CSS/UserInfoPage.css' rel='stylesheet' />
    <link href='~/Content/CSS/ProductDetailPage.css' rel='stylesheet' />
    <link href='~/Content/CSS/CartPage.css' rel='stylesheet' />
    <link href='~/Content/CSS/AddressPage.css' rel='stylesheet' />
}
@section Scripts{
    <script src='~/Scripts/All.js'></script>
    <script src='~/Scripts/MainPage/MainPage.js'></script>
    <script src='~/Scripts/CartPage/CartPage.js'></script>
    <script src='~/Scripts/ProductDetailPage/ProductDetailPage.js'></script>
    <script src='~/Scripts/UserInfoPage/UserInfoPage.js'></script>
    <script src='~/Scripts/AddressPage/AddressPage.js'></script>

    <script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>

    <script>
        try {
            var time;
            var timecount = 0;
            wx.config({
                debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                appId: '@{@ViewBag.appId;}', // 必填，公众号的唯一标识
                timestamp: '@{@ViewBag.timestamp;}', // 必填，生成签名的时间戳
                nonceStr: '@{@ViewBag.noncestr;}', // 必填，生成签名的随机串
                signature: '@{@ViewBag.sign;}',// 必填，签名，见附录1
                jsApiList: [
                    'chooseWXPay',
                ] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
            });
            //wx.ready(function () {
            $(function () {
                $("#btnpay").click(function () {
                    //layer.open({ type: 2, content: "正在创建订单…", shadeClose: false });//加载loading层

                    if (!IsOnLine()) { return false; }
                    $.ajax({
                        url: WebSiteName + "/WeChat/WxPay?actionString=jspay",
                        type: "POST",
                        data: $("form").serialize(),
                        cache: false,
                        timeout: 8000,
                        success: function (data) {
                            if (data.status == 'OK') {
                                var param = data.info;
                                wx.chooseWXPay({
                                    timestamp: param.timeStamp, // 支付签名时间戳，注意微信jssdk中的所有使用timestamp字段均为小写。但最新版的支付后台生成签名使用的timeStamp字段名需大写其中的S字符
                                    nonceStr: param.nonceStr, // 支付签名随机串，不长于 32 位
                                    package: param.package, // 统一支付接口返回的prepay_id参数值，提交格式如：prepay_id=***）
                                    signType: param.signType, // 签名方式，默认为'SHA1'，使用新版支付需传入'MD5'
                                    paySign: param.paySign, // 支付签名
                                    success: function (res) {
                                        alert("支付成功：" + JSON.stringify(res));
                                        //layer.open({ type: 2, content: "正在查询订单状态…", shadeClose: false });
                                        time = setInterval(function () { queryorder($("input[name='out_trade_no']").val()); }, 2000);

                                        // 支付成功后的回调函数
                                    },
                                    cancel: function (res) {
                                        alert(JSON.stringify(res));
                                    }
                                });
                            }
                            else {
                                alert("支付失败：" + data.info);
                            }
                            return false;//Flag
                        },
                        error: function (XMLHttpRequest, textStatus, errorThrown) {
                            //textStatus=timeout
                            if (textStatus != null) {
                                $.toast("网络超时，请稍后再试");
                            }
                                //Not Found Internal Server Error
                            else if (errorThrown != null) {
                                $.toast("连接服务器异常，请稍后再试");
                            }
                            return false;//Flag
                        },
                    });

                    return;

                    $.post(
                        "/WeChat/WxPay?actionString=jspay",
                        $("form").serialize(),
                        function (data) {
                            //layer.closeAll();//关闭load层
                            if (data.status == "OK") {
                                var param = data.info;
                                wx.chooseWXPay({
                                    timestamp: param.timeStamp, // 支付签名时间戳，注意微信jssdk中的所有使用timestamp字段均为小写。但最新版的支付后台生成签名使用的timeStamp字段名需大写其中的S字符
                                    nonceStr: param.nonceStr, // 支付签名随机串，不长于 32 位
                                    package: param.package, // 统一支付接口返回的prepay_id参数值，提交格式如：prepay_id=***）
                                    signType: param.signType, // 签名方式，默认为'SHA1'，使用新版支付需传入'MD5'
                                    paySign: param.paySign, // 支付签名
                                    success: function (res) {
                                        //layer.open({ type: 2, content: "正在查询订单状态…", shadeClose: false });
                                        time = setInterval(function () { queryorder($("input[name='out_trade_no']").val()); }, 2000);

                                        // 支付成功后的回调函数

                                    },
                                    cancel: function (res) {
                                        alert(JSON.stringify(res));
                                    }
                                });
                            } else {
                                alert(data.info);
                            }
                        }, "json");
                });
            });

            function queryorder(tradeno) {
                if (timecount++ < 3) {
                    $.post("/WeChat/WxPay?actionString=query", { out_trade_no: tradeno }, function (data, status) {
                        if (data == "SUCCESS") {
                            layer.closeAll();
                            alert("支付成功！");
                            clearInterval(time);
                        }
                    });
                } else {
                    layer.closeAll();
                    alert("订单貌似没有支付成功！");
                    clearInterval(time);
                }

            }
        }
        catch (ex) {
            alert("支付初始化异常:\r\n" + ex);
        }
    </script>

}
<h2>Test</h2>

<body>
    <div class="page page-current" id="MyShopPage">
        <div class="content">
            <form>
                @{
                    string OrderNo = Guid.NewGuid().ToString("N").Remove(20);
                }
                <!--秘钥 123456789012345678901234567890AB-->
                商品名：<input type="text" name="body" value="测试商品" /><br />
                商品详情：<input type="text" name="detail" value="Test Detail" /><br />
                订单号：<input type="text" name="out_trade_no" value="@OrderNo" /><br />
                订单金额：<input type="text" name="total_fee" value="100" /><br />
                <input type="hidden" name="msgid" value="oW6iuwaqD3IrSjHZHnL1mzj2c9g4" /><br />
                <input type="button" id="btnpay" value="支付" />
                <input type="button" id="reverse" value="撤销订单" />
                <input type="button" id="close" value="关闭订单" />
            </form>
        </div>
        <!-- 工具栏 -->
        <nav class='bar bar-tab myfooter'>
            @*<a class='tab-item' id='MyShopPage-OK'>确认</a>*@
            <a class='tab-item active pull-left MyBack' id="ConfirmPage-Back">
                <span class='icon icon-left'></span>
            </a>
        </nav>
    </div>
    
</body>